# coding=utf-8

"""
Train a Transformer ML Model for Planning
"""

import logging
import os
os.environ["WANDB_DISABLED"] = "true"


from tqdm import tqdm
import torch
from torch.utils.data import DataLoader

from dataset_gen.waymo.waymo_dataset import WaymoDataset
from dataset_gen.waymo.config import cfg_from_yaml_file, cfg
from sklearn.cluster import KMeans

__all__ = {
    'WaymoDataset': WaymoDataset,
}
    
cfg_from_yaml_file("/home/QJ00367/danjiao/dlnets/transformer4planning/config/config_gpt2_small.yaml", cfg)
logger = logging.getLogger(__name__)

train_set = __all__[cfg.DATA_CONFIG.DATASET](
    dataset_cfg=cfg.DATA_CONFIG,
    training=True,
    logger=logger, 
    use_raster=False
)

batch_size = 16
workers = 8

dataloader = DataLoader(
    train_set, batch_size=batch_size, pin_memory=True, num_workers=workers,
    shuffle=None, collate_fn=train_set.collate_batch,
    drop_last=False, sampler=None, timeout=0, 
    worker_init_fn=None
)

select_point_index = 39
select_type = 'TYPE_CYCLIST'

k = 64
model = KMeans(n_clusters=k, init="random",
               max_iter=200, tol=1e-04)

print("len dataloader ", len(dataloader))
traj_data = []
for i, batch_dict in tqdm(enumerate(dataloader)):
    traj_label = batch_dict['input_dict']['trajectory_label']
    objects_type = batch_dict['input_dict']['center_objects_type']
    center_gt_trajs_mask = batch_dict['input_dict']['center_gt_trajs_mask']
    
    valid_mask = (center_gt_trajs_mask[:, select_point_index].bool()) & (objects_type == select_type)
    valid_mask = valid_mask.bool()
    traj_label = traj_label[:, select_point_index, :][valid_mask]
    
    
    traj_data.append(traj_label[:, :2])

all_traj_data = torch.cat(traj_data, dim=0).numpy()

model = model.fit(all_traj_data)

print("cluster res \n ", model.cluster_centers_)

# CYCLELIST, 39
#   [[ 1.97710991e+00  1.23980641e-02]
#  [ 2.01196232e+01 -3.94404620e-01]
#  [ 1.39289732e+01 -6.75370693e-01]
#  [ 3.23781548e+01 -6.42983615e-02]
#  [ 1.53393745e-01  4.44671512e-03]
#  [ 8.62253380e+00 -5.64008999e+00]
#  [ 1.78957443e+01  1.96208346e+00]
#  [ 1.87496147e+01  1.33592339e+01]
#  [ 1.07495937e+01 -2.13112056e-01]
#  [ 1.54189606e+01 -3.25110555e-03]
#  [ 2.52276382e+01  8.93327594e-02]
#  [ 5.02859840e+01  1.71921372e-01]
#  [ 1.26412640e+01 -2.97419524e+00]
#  [ 1.84829979e+01 -2.26454854e+00]
#  [ 1.17753563e+01  1.56441915e+00]
#  [ 1.69883614e+01 -9.66790617e-02]
#  [ 3.10646439e+01  4.02335453e+00]
#  [ 3.58834229e+01  1.04650751e-01]
#  [ 4.11000977e+01 -6.64276183e-02]
#  [ 1.51017027e+01 -4.83779621e+00]
#  [ 2.59002285e+01 -3.13243914e+00]
#  [ 2.17540150e+01 -1.06913745e-01]
#  [ 4.11296177e+00  1.82547569e+00]
#  [ 1.03953972e+01  4.17474842e+00]
#  [ 1.85551090e+01 -5.69176376e-02]
#  [ 1.49403601e+01 -1.29435225e+01]
#  [ 2.29299774e+01  1.69634259e+00]
#  [ 1.00661964e+01 -2.49609637e+00]
#  [ 5.65945911e+00 -2.80807316e-02]
#  [ 1.33349247e+01  6.98099852e+00]
#  [ 7.45839882e+00  3.01245689e-01]
#  [ 7.62667942e+00  1.21367188e+01]
#  [ 3.75323486e+00 -6.29673600e-01]
#  [ 1.67980633e+01  4.93712091e+00]
#  [ 1.56679497e+01  1.80757880e+00]
#  [ 1.37270422e+01  8.94537926e-01]
#  [ 2.72856064e+01 -3.33985388e-02]
#  [ 2.96225090e+01 -1.20858788e-01]
#  [ 1.81103477e+01  8.63754272e+00]
#  [ 1.57657728e+01 -1.91709352e+00]
#  [ 3.96424961e+00  6.94022512e+00]
#  [ 8.81737328e+00 -1.04194193e+01]
#  [ 2.17687569e+01 -3.15516329e+00]
#  [ 2.01808624e+01  1.43805218e+00]
#  [ 1.83887234e+01 -6.99436903e+00]
#  [ 8.88616657e+00 -6.18940592e-01]
#  [ 1.23104153e+01 -3.13655943e-01]
#  [ 2.32805309e+01 -1.07081919e+01]
#  [ 1.36177444e+01  3.50722504e+00]
#  [ 3.20051613e+01 -5.37809563e+00]
#  [ 3.88163376e+00 -6.34679651e+00]
#  [ 1.22150707e+01 -7.26943779e+00]
#  [ 2.34376278e+01 -3.54204208e-01]
#  [ 2.44343204e+01  9.17802525e+00]
#  [ 2.06415958e+01  5.11215925e+00]
#  [ 1.33209143e+01  1.10853415e+01]
#  [ 7.62324677e+01 -2.06423491e-01]
#  [ 6.59414005e+00 -2.58262610e+00]
#  [-5.68427753e+00  3.82598191e-01]
#  [ 7.14459705e+00  3.32037878e+00]
#  [ 9.55109787e+00  1.36067224e+00]
#  [ 2.59351883e+01  3.19929338e+00]
#  [ 2.80559254e+01  1.49081411e+01]
#  [ 9.02449799e+00  7.58224392e+00]]

# CYCLELIST, 79
# [[ 1.55135756e+01 -1.05273867e+01]
#  [ 4.59067116e+01  4.99577808e+00]
#  [ 6.04960022e+01  3.89739275e-02]
#  [ 2.96206951e+01  2.44301915e+00]
#  [ 1.92043571e+01  1.59550295e+01]
#  [ 1.89343071e+01  2.23053789e+00]
#  [ 3.33493958e+01  1.87112570e-01]
#  [ 2.12125263e+01 -2.05530739e+01]
#  [ 4.13907509e+01  1.36404359e+00]
#  [ 5.47863426e+01  1.75253510e-01]
#  [ 4.06458893e+01 -2.18452168e+00]
#  [ 3.85795898e+01 -9.76356888e+00]
#  [ 6.32835159e+01  9.47434616e+00]
#  [ 1.34146118e+00  2.17455959e+01]
#  [-1.65120239e+01  3.42595518e-01]
#  [ 1.47882938e+01  7.38431931e+00]
#  [ 3.92173500e+01  5.94246912e+00]
#  [ 6.77061462e+01  2.12944627e-01]
#  [ 5.80135536e+00 -1.02899561e+01]
#  [ 3.72927017e+01  5.66807091e-01]
#  [ 2.44585514e+01  3.94531155e+00]
#  [ 3.39869995e+01  4.64811230e+00]
#  [ 1.43065357e+01  3.48200989e+01]
#  [ 1.36798229e+01 -3.14050789e+01]
#  [ 2.75568848e+01  1.70069180e+01]
#  [ 1.90551968e+01 -3.55687046e+00]
#  [ 5.44963837e-01 -2.10730648e+01]
#  [ 2.88063965e+01  3.73755264e+01]
#  [ 2.40197392e+01  2.58776073e+01]
#  [ 2.18332062e+01  8.95334721e+00]
#  [ 3.03446159e+01 -1.86413515e+00]
#  [ 2.85184460e+01  8.28913212e+00]
#  [ 2.34330292e+01 -1.13866024e+01]
#  [ 1.74862289e+00 -7.01816082e-02]
#  [ 5.24861984e+01  2.36105022e+01]
#  [ 4.40787964e+01  1.43175392e+01]
#  [ 6.48350830e+01 -9.41416359e+00]
#  [ 1.41905365e+01  2.40333023e+01]
#  [ 2.50275078e+01 -4.48781204e+00]
#  [ 7.71467285e+01  3.48443031e-01]
#  [ 5.27559738e+01  7.16193819e+00]
#  [ 1.20782032e+01 -1.89789791e+01]
#  [ 2.23427315e+01 -3.03526282e-01]
#  [ 2.65754185e+01 -2.51264453e-01]
#  [ 1.14323769e+01  1.57169409e+01]
#  [ 6.63696098e+00  8.83264637e+00]
#  [ 3.52856789e+01  2.40272274e+01]
#  [ 3.49211960e+01  1.24160490e+01]
#  [ 3.07283039e+01 -7.79082012e+00]
#  [ 1.14937515e+01 -4.26348972e+00]
#  [ 9.38005829e+01  2.62078166e-01]
#  [ 3.56667824e+01 -3.30666161e+00]
#  [ 1.51680899e+01 -1.33378267e-01]
#  [ 3.27979355e+01 -1.87252522e+01]
#  [ 1.05026493e+01  1.01436055e+00]
#  [ 4.98999252e+01 -1.06152654e-01]
#  [ 6.00091171e+00 -2.29033232e-01]
#  [ 4.53900414e+01 -2.20072150e-01]
#  [ 4.57869530e+01 -6.14160156e+00]
#  [ 2.84256039e+01 -3.34883919e+01]
#  [ 5.47111320e+01 -6.23857403e+00]
#  [ 4.32438736e+01  3.66067772e+01]
#  [ 1.33299713e+02 -1.53764522e+00]
#  [ 4.78179588e+01 -2.09246140e+01]]
